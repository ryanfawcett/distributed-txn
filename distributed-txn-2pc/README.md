# 两阶段提交(2PC)

### 两阶段提交概述


两阶段提交(Two Phase Commit, 2PC), 是一种可以保证数据的强一致性的分布式事务解决方案。

顾名思义, 2PC分为以下两个阶段:

- 准备阶段(Prepare Phase)
- 提交阶段(Commit Phase)


在2PC协议中, 系统一般包含两种角色:

- 协调者(Coordinator), 通常只有一个
- 参与者(Participant), 一般包含多个, 在数据存储系统中可以理解为数据副本的个数


### 准备阶段(Prepare Phase)


在准备阶段, 协调者将通知事务参与者准备提交或回滚事务, 写本地的redo和undo日志, 但不提交事务, 然后进入表决过程。
在表决过程中, 参与者将告知协调者自己的决策：同意(参与者本地事务执行成功) 或 回滚(参与者本地事务执行失败)。


协调者流程：

- 写本地日志 `BEGIN_COMMIT`, 并进入等待状态
- 向所有事务的参与者发送 `VOTE_REQUEST` 消息
- 等待并接收参与者发送的对 `VOTE_REQUEST` 的响应, 参与者响应 `VOTE_ABORT` 或 `VOTE_COMMIT` 消息给协调者

### 提交阶段(Commit Phase)

在该阶段, 协调者将基于第一阶段的投票结果进行决策：提交或回滚。只有所有参与者同意提交事务时, 协调者才会通知所有参与者提交事务；否则协调者将通知所有的参与者回滚事务。
参与者在接收到协调者的消息后将执行对应的操作

协调者流程：

- 如果收到任何一个参与者发送的 `VOTE_ABORT` 消息
	- 写本地 `GLOBAL_ABORT` 日志, 进入 ABORT 状态
	- 向所有的参与者发送 `GLOBAL_ABORT` 消息
- 如果收到所有的参与者发送的 `VOTE_COMMIT` 消息
	- 写本地 `GLOBAL_COMMIT` 日志, 进入 COMMIT 状态
	- 向所有参与者发送 `GLOBAL_COMMIT` 消息
- 等待并接收参与者发送的对 `GLOBAL_ABORT/COMMIT` 消息的确认响应消息, 一旦收到所有参与者的确认消息, 写本地 `END_TRANSACTION` 日志结束事务


### 版本支持

MySQL 5.5及以上版本, SQL Server 2005, Oracle 7

### 两阶段提交的缺点

- 同步阻塞问题。在执行事务的过程中, 所有参与者都是事务阻塞的, 会长时间占用资源。
- 单点故障。由于协调者的重要性, 一旦协调者发生故障, 参与者会一直阻塞, 可以对协调者做集群, 但是集群也无法解决因为协调者宕机而导致参与者处于阻塞的状态。
- 数据不一致。在提交阶段时, 当协调者向参与者发送提交请求之后, 发生了局部网络异常或协调者发生了故障, 这会导致只有一部分的参与者收到了提交事务的请求, 收到提交事务请求的参与者会执行提交操作, 
但是其他部分未收到提交事务请求的参与者则无法执行提交事务的操作, 于是整个分布式系统便会出现数据不一致的情况。